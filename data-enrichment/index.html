<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Enrichment Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Georgia', 'Times New Roman', serif; background: #ffffff; color: #333; line-height: 1.6; }
        .header { background: #C8102E; color: white; padding: 30px 20px; text-align: center; border-bottom: 3px solid #8B0000; }
        .back-link { display: inline-block; color: white; text-decoration: none; font-size: 14px; margin-bottom: 15px; opacity: 0.9; transition: opacity 0.2s; }
        .back-link:hover { opacity: 1; text-decoration: underline; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .section { background: white; border-radius: 4px; padding: 25px; margin-bottom: 25px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .section h3 { color: #333; margin-bottom: 15px; font-size: 18px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #C8102E; box-shadow: 0 0 0 2px rgba(200,16,46,0.1); }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; }
        .info-button { background: #C8102E; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; width: 100%; }
        .info-button:hover { background: #8B0000; }
        .info-button:disabled { background: #ccc; cursor: not-allowed; }
        .info-button.success { background: #10b981; }
        .info-button.success:hover { background: #059669; }
        .reset-btn { background: #C8102E; color: white; border: none; padding: 6px 12px; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .reset-btn:hover { background: #8B0000; }
        .enrichment-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .option-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
        .option-card:hover { border-color: #C8102E; background: #fef7f7; }
        .option-card.selected { border-color: #C8102E; background: #fef7f7; }
        .option-card input[type="checkbox"] { margin-right: 10px; accent-color: #C8102E; }
        .option-card .title { font-weight: 600; color: #333; }
        .option-card .desc { font-size: 12px; color: #666; margin-top: 5px; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        .preview-table th { background: #f5f5f5; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        .preview-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .preview-table tr:hover { background: #fafafa; }
        .status-message { padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .status-message.info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; display: block; }
        .status-message.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; display: block; }
        .status-message.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: block; }
        .progress-bar-bg { background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; margin: 15px 0; }
        .progress-bar { background: #C8102E; height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-link">‚Üê Back to All Tools</a>
        <h1>üìä Data Enrichment</h1>
        <p>Enrich your CSV data with Red Cross organizational codes, demographics, and geographic data</p>
    </div>
    <div class="container">
        <div id="statusMessage" class="status-message"></div>

        <div class="section">
            <h3>üìÅ Upload Data <button onclick="resetTool()" class="reset-btn">Reset</button></h3>
            <div class="input-group">
                <label>Upload CSV File:</label>
                <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
                <p class="help-text">Upload a CSV with geographic identifiers (ZIP codes, FIPS codes, addresses, etc.)</p>
            </div>
        </div>

        <div class="section hidden" id="configSection">
            <h3>‚öôÔ∏è Configure Enrichment</h3>

            <div class="input-group">
                <label>Select the column containing your geographic identifier:</label>
                <select id="geoColumn" onchange="detectColumnType()">
                    <option value="">-- Select Column --</option>
                </select>
            </div>

            <div class="input-group">
                <label>Select enrichment fields to add:</label>
                <div class="enrichment-options">
                    <label class="option-card">
                        <input type="checkbox" value="chapter" checked>
                        <span class="title">Chapter Name</span>
                        <div class="desc">Red Cross chapter serving this area</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="ecode" checked>
                        <span class="title">ECODE</span>
                        <div class="desc">Chapter entity code</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="region" checked>
                        <span class="title">Region</span>
                        <div class="desc">Red Cross region name</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="rcode" checked>
                        <span class="title">RCODE</span>
                        <div class="desc">Region code</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="division">
                        <span class="title">Division</span>
                        <div class="desc">Red Cross division name</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="dcode">
                        <span class="title">DCODE</span>
                        <div class="desc">Division code</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="county">
                        <span class="title">County</span>
                        <div class="desc">County name</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="fips">
                        <span class="title">FIPS Code</span>
                        <div class="desc">County FIPS code</div>
                    </label>
                    <label class="option-card">
                        <input type="checkbox" value="state">
                        <span class="title">State</span>
                        <div class="desc">State abbreviation</div>
                    </label>
                </div>
            </div>

            <button onclick="enrichData()" class="info-button" id="enrichBtn">
                üöÄ Enrich Data
            </button>
        </div>

        <div class="section hidden" id="resultsSection">
            <h3>‚úÖ Enrichment Results</h3>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <p id="progressText" style="text-align: center; color: #666;"></p>

            <div class="input-group">
                <label>Preview (first 10 rows):</label>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewTable"></table>
                </div>
            </div>

            <button onclick="downloadEnriched()" class="info-button success" id="downloadBtn">
                üíæ Download Enriched CSV
            </button>
        </div>

        <div class="section" style="background: #fef3c7; border: 1px solid #fcd34d;">
            <h3 style="color: #92400e;">üìñ How to Use</h3>
            <ol style="margin: 10px 0; padding-left: 20px; font-size: 14px; color: #78350f;">
                <li>Upload a CSV file with ZIP codes or other geographic identifiers</li>
                <li>Select the column containing the geographic data</li>
                <li>Choose which enrichment fields you want to add</li>
                <li>Click "Enrich Data" to process your file</li>
                <li>Download the enriched CSV with additional columns</li>
            </ol>
        </div>
    </div>

    <script>
        let csvData = [];
        let csvHeaders = [];
        let enrichedData = [];
        let lookupData = [];

        const LOOKUP_URL = 'https://raw.githubusercontent.com/franzenjb/red-cross-data/main/lookup-tables/zip_to_redcross.csv';

        function showStatus(message, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = 'status-message ' + type;
        }

        function resetTool() {
            csvData = [];
            csvHeaders = [];
            enrichedData = [];
            document.getElementById('csvFile').value = '';
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('geoColumn').innerHTML = '<option value="">-- Select Column --</option>';
            document.getElementById('previewTable').innerHTML = '';
            document.getElementById('statusMessage').className = 'status-message';
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showStatus('Reading CSV file...', 'info');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    document.getElementById('configSection').classList.remove('hidden');
                    showStatus(`Loaded ${csvData.length} rows`, 'success');
                } catch (error) {
                    showStatus('Error parsing CSV: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            csvHeaders = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            csvData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= csvHeaders.length) {
                    const row = {};
                    csvHeaders.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    });
                    csvData.push(row);
                }
            }

            const geoSelect = document.getElementById('geoColumn');
            csvHeaders.forEach(header => {
                geoSelect.innerHTML += `<option value="${header}">${header}</option>`;
            });
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current); current = ''; }
                else current += char;
            }
            result.push(current);
            return result;
        }

        function detectColumnType() {
            // Auto-detect based on column name
        }

        async function enrichData() {
            const geoColumn = document.getElementById('geoColumn').value;
            if (!geoColumn) {
                showStatus('Please select a geographic column', 'error');
                return;
            }

            const selectedFields = Array.from(document.querySelectorAll('.enrichment-options input:checked')).map(cb => cb.value);
            if (selectedFields.length === 0) {
                showStatus('Please select at least one enrichment field', 'error');
                return;
            }

            document.getElementById('resultsSection').classList.remove('hidden');
            showStatus('Loading lookup data...', 'info');

            try {
                if (lookupData.length === 0) {
                    const response = await fetch(LOOKUP_URL);
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());

                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((h, idx) => { row[h] = values[idx] ? values[idx].trim() : ''; });
                        lookupData.push(row);
                    }
                }

                // Create lookup map by ZIP
                const zipLookup = {};
                lookupData.forEach(row => {
                    zipLookup[row.ZIP_CODE] = row;
                });

                // Enrich data
                enrichedData = [];
                const fieldMap = {
                    chapter: 'Chapter', ecode: 'ECODE', region: 'Region', rcode: 'RCODE',
                    division: 'Division', dcode: 'DCODE', county: 'County', fips: 'COUNTY_FIPS', state: 'State'
                };

                for (let i = 0; i < csvData.length; i++) {
                    const row = { ...csvData[i] };
                    const geoValue = String(row[geoColumn] || '').padStart(5, '0');
                    const lookup = zipLookup[geoValue] || {};

                    selectedFields.forEach(field => {
                        const lookupField = fieldMap[field];
                        row['enriched_' + field] = lookup[lookupField] || '';
                    });

                    enrichedData.push(row);

                    const progress = Math.round(((i + 1) / csvData.length) * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressBar').textContent = progress + '%';
                }

                document.getElementById('progressText').textContent = `Enriched ${enrichedData.length} rows`;
                showPreview(selectedFields);
                showStatus('Enrichment complete!', 'success');

            } catch (error) {
                showStatus('Error enriching data: ' + error.message, 'error');
            }
        }

        function showPreview(selectedFields) {
            const table = document.getElementById('previewTable');
            const allHeaders = [...csvHeaders, ...selectedFields.map(f => 'enriched_' + f)];

            let html = '<thead><tr>';
            allHeaders.forEach(h => { html += `<th>${h}</th>`; });
            html += '</tr></thead><tbody>';

            enrichedData.slice(0, 10).forEach(row => {
                html += '<tr>';
                allHeaders.forEach(h => { html += `<td>${row[h] || ''}</td>`; });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function downloadEnriched() {
            if (enrichedData.length === 0) return;

            const headers = Object.keys(enrichedData[0]);
            let csv = headers.join(',') + '\n';
            enrichedData.forEach(row => {
                csv += headers.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'enriched_data_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Downloaded!', 'success');
        }
    </script>
</body>
</html>
