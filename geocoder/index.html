<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapBox Geocoding Tool</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: #B71C1C;
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .input-group textarea,
        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .info-button {
            background: #B71C1C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .info-button:hover {
            background: #8B0000;
        }
        
        .info-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .reset-btn {
            background: #e64a19;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .reset-btn:hover {
            background: #bf360c;
        }
        
        .api-key-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .api-key-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .api-key-section p {
            font-size: 13px;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .api-key-section a {
            color: #0066cc;
            text-decoration: underline;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        
        .results-section {
            margin-top: 20px;
        }
        
        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #4caf50;
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-text {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .results-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .results-table tr:hover {
            background: #f9f9f9;
        }
        
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .download-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 15px;
        }
        
        .download-btn:hover {
            background: #45a049;
        }
        
        .hidden {
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìç MapBox Geocoding Tool</h1>
        <p>Convert addresses to coordinates using MapBox Geocoding API</p>
    </div>
    
    <div class="container">
        <!-- API Key Section -->
        <div class="section">
            <div class="api-key-section">
                <h4>üîë MapBox API Key Required</h4>
                <p>Get your free API key at <a href="https://account.mapbox.com/access-tokens/" target="_blank">mapbox.com/access-tokens</a></p>
                <p><strong>Free Tier:</strong> 100,000 geocodes per month</p>
                <div class="input-group">
                    <input type="password" id="mapbox-api-key" placeholder="Enter your MapBox API key (pk.eyJ...)" />
                    <button onclick="saveApiKey()" class="info-button" style="margin-top: 10px;">Save API Key</button>
                </div>
                <p class="help-text">Your API key is stored locally in your browser and never sent to our servers.</p>
            </div>
        </div>
        
        <!-- Geocoding Interface -->
        <div class="section" id="geocoding-interface" style="display: none;">
            <h3>
                Geocoding Options
                <button onclick="resetTool()" class="reset-btn">Reset</button>
            </h3>
            
            <div class="two-column">
                <div>
                    <h4 style="margin-bottom: 15px;">Single Address Geocoding</h4>
                    <div class="input-group">
                        <label>Enter Address:</label>
                        <textarea id="address-input" rows="3" placeholder="e.g., 1600 Pennsylvania Avenue NW, Washington, DC"></textarea>
                    </div>
                    <button onclick="geocodeAddress()" class="info-button">üîç Geocode Address</button>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 15px;">Batch Geocoding (CSV)</h4>
                    <div class="input-group">
                        <label>Upload CSV File:</label>
                        <input type="file" id="csv-file-input" accept=".csv" />
                        <p class="help-text">CSV should have an "address" column. Results will include latitude, longitude, place name, and confidence score.</p>
                    </div>
                    <button onclick="geocodeBatch()" class="info-button">üìä Geocode CSV File</button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section hidden" id="geocoding-results">
                <h4 style="margin-bottom: 15px;">Geocoding Results</h4>
                
                <div class="status-text">
                    <span>Progress: <span id="geocode-progress">0</span> / <span id="geocode-total">0</span></span>
                    <span id="geocode-status" style="margin-left: 20px;"></span>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="geocode-progress-bar" style="width: 0%">0%</div>
                </div>
                
                <div id="results-table-container"></div>
                
                <button onclick="downloadResults()" class="download-btn">üì• Download Results CSV</button>
            </div>
            
            <!-- Map Display -->
            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px;">Map Visualization</h4>
                <div id="geocoding-map" class="map-container"></div>
            </div>
        </div>
    </div>
    
    <script>
        let mapboxApiKey = localStorage.getItem('mapbox_api_key') || '';
        let geocodingMap = null;
        let geocodingResults = [];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (mapboxApiKey) {
                document.getElementById('mapbox-api-key').value = mapboxApiKey;
                document.getElementById('geocoding-interface').style.display = 'block';
            }
        });
        
        function saveApiKey() {
            const apiKey = document.getElementById('mapbox-api-key').value.trim();
            if (!apiKey) {
                alert('Please enter a MapBox API key');
                return;
            }
            if (!apiKey.startsWith('pk.')) {
                alert('Invalid MapBox API key format. Should start with "pk."');
                return;
            }
            mapboxApiKey = apiKey;
            localStorage.setItem('mapbox_api_key', apiKey);
            document.getElementById('geocoding-interface').style.display = 'block';
            alert('API key saved successfully!');
        }
        
        async function geocodeAddress() {
            if (!mapboxApiKey) {
                alert('Please enter and save your MapBox API key first');
                return;
            }
            
            const address = document.getElementById('address-input').value.trim();
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            try {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxApiKey}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const result = {
                        address: address,
                        latitude: feature.center[1],
                        longitude: feature.center[0],
                        place_name: feature.place_name,
                        confidence: feature.relevance || 'N/A'
                    };
                    
                    geocodingResults = [result];
                    document.getElementById('geocoding-results').classList.remove('hidden');
                    document.getElementById('geocode-total').textContent = '1';
                    document.getElementById('geocode-progress').textContent = '1';
                    document.getElementById('geocode-progress-bar').style.width = '100%';
                    document.getElementById('geocode-status').textContent = 'Completed!';
                    displayResults([result]);
                    displayMap([result]);
                } else {
                    alert('No results found for this address');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error geocoding address. Please check your API key and try again.');
            }
        }
        
        async function geocodeBatch() {
            if (!mapboxApiKey) {
                alert('Please enter and save your MapBox API key first');
                return;
            }
            
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const addressIndex = headers.findIndex(h => h.includes('address'));
                
                if (addressIndex === -1) {
                    alert('CSV file must have an "address" column');
                    return;
                }
                
                const addresses = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        if (values[addressIndex]) {
                            addresses.push({
                                row: i,
                                address: values[addressIndex].trim(),
                                originalData: values,
                                headers: headers
                            });
                        }
                    }
                }
                
                if (addresses.length === 0) {
                    alert('No addresses found in CSV file');
                    return;
                }
                
                if (addresses.length > 100000) {
                    alert('Batch size exceeds MapBox free tier limit of 100,000 geocodes');
                    return;
                }
                
                document.getElementById('geocoding-results').classList.remove('hidden');
                document.getElementById('geocode-total').textContent = addresses.length;
                geocodingResults = [];
                
                // Geocode addresses with rate limiting
                for (let i = 0; i < addresses.length; i++) {
                    const item = addresses[i];
                    try {
                        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(item.address)}.json?access_token=${mapboxApiKey}`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.features && data.features.length > 0) {
                            const feature = data.features[0];
                            geocodingResults.push({
                                ...item,
                                latitude: feature.center[1],
                                longitude: feature.center[0],
                                place_name: feature.place_name,
                                confidence: feature.relevance || 0
                            });
                        } else {
                            geocodingResults.push({
                                ...item,
                                latitude: null,
                                longitude: null,
                                place_name: 'Not found',
                                confidence: 0
                            });
                        }
                        
                        // Update progress
                        document.getElementById('geocode-progress').textContent = i + 1;
                        const progress = ((i + 1) / addresses.length) * 100;
                        document.getElementById('geocode-progress-bar').style.width = progress + '%';
                        document.getElementById('geocode-progress-bar').textContent = Math.round(progress) + '%';
                        document.getElementById('geocode-status').textContent = `Geocoded ${i + 1} of ${addresses.length}`;
                        
                        // Rate limiting: MapBox allows 600 requests per minute
                        if ((i + 1) % 100 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                        console.error(`Error geocoding ${item.address}:`, error);
                        geocodingResults.push({
                            ...item,
                            latitude: null,
                            longitude: null,
                            place_name: 'Error',
                            confidence: 0
                        });
                    }
                }
                
                displayResults(geocodingResults);
                displayMap(geocodingResults.filter(r => r.latitude && r.longitude));
                document.getElementById('geocode-status').textContent = `Completed! ${geocodingResults.filter(r => r.latitude).length} successful geocodes`;
            } catch (error) {
                console.error('Batch geocoding error:', error);
                alert('Error processing CSV file');
            }
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function displayResults(results) {
            const container = document.getElementById('results-table-container');
            if (results.length === 0) return;
            
            let html = '<table class="results-table"><thead><tr>';
            html += '<th>Address</th>';
            html += '<th>Latitude</th>';
            html += '<th>Longitude</th>';
            html += '<th>Place Name</th>';
            html += '<th>Confidence</th>';
            html += '</tr></thead><tbody>';
            
            results.forEach(result => {
                html += '<tr>';
                html += `<td>${escapeHtml(result.address || (result.originalData ? result.originalData.join(', ') : 'N/A'))}</td>`;
                html += `<td>${result.latitude ? result.latitude.toFixed(6) : 'N/A'}</td>`;
                html += `<td>${result.longitude ? result.longitude.toFixed(6) : 'N/A'}</td>`;
                html += `<td>${escapeHtml(result.place_name || 'N/A')}</td>`;
                html += `<td>${result.confidence !== undefined && result.confidence !== 'N/A' ? result.confidence.toFixed(2) : 'N/A'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function displayMap(results) {
            if (!mapboxApiKey || results.length === 0) return;
            
            const validResults = results.filter(r => r.latitude && r.longitude);
            if (validResults.length === 0) return;
            
            // Initialize map if not already created
            if (!geocodingMap) {
                mapboxgl.accessToken = mapboxApiKey;
                geocodingMap = new mapboxgl.Map({
                    container: 'geocoding-map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [validResults[0].longitude, validResults[0].latitude],
                    zoom: 10
                });
                
                // Wait for map to load before adding markers
                geocodingMap.once('load', function() {
                    addMarkersToMap(validResults);
                });
            } else {
                // Map already exists, add markers directly
                addMarkersToMap(validResults);
            }
        }
        
        function addMarkersToMap(validResults) {
            // Clear existing markers
            const markers = document.querySelectorAll('.mapboxgl-marker');
            markers.forEach(m => m.remove());
            
            // Add markers for each result
            validResults.forEach((result) => {
                const el = document.createElement('div');
                el.className = 'marker';
                el.style.backgroundColor = '#B71C1C';
                el.style.width = '20px';
                el.style.height = '20px';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid white';
                el.style.cursor = 'pointer';
                
                new mapboxgl.Marker(el)
                    .setLngLat([result.longitude, result.latitude])
                    .setPopup(new mapboxgl.Popup().setHTML(
                        `<strong>${escapeHtml(result.address || 'Address')}</strong><br>` +
                        `${escapeHtml(result.place_name || '')}<br>` +
                        `Lat: ${result.latitude.toFixed(6)}, Lng: ${result.longitude.toFixed(6)}`
                    ))
                    .addTo(geocodingMap);
            });
            
            // Fit map to show all markers
            if (validResults.length > 0) {
                const bounds = validResults.reduce((bounds, result) => {
                    return bounds.extend([result.longitude, result.latitude]);
                }, new mapboxgl.LngLatBounds(
                    [validResults[0].longitude, validResults[0].latitude], 
                    [validResults[0].longitude, validResults[0].latitude]
                ));
                
                geocodingMap.fitBounds(bounds, { padding: 50 });
            }
        }
        
        function downloadResults() {
            if (geocodingResults.length === 0) {
                alert('No results to download');
                return;
            }
            
            let csv = 'Address,Latitude,Longitude,Place Name,Confidence\n';
            geocodingResults.forEach(result => {
                const address = result.address || (result.originalData ? result.originalData.join(',') : '');
                csv += `"${address.replace(/"/g, '""')}",${result.latitude || ''},${result.longitude || ''},"${(result.place_name || '').replace(/"/g, '""')}",${result.confidence || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geocoding_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function resetTool() {
            document.getElementById('address-input').value = '';
            document.getElementById('csv-file-input').value = '';
            document.getElementById('geocoding-results').classList.add('hidden');
            document.getElementById('results-table-container').innerHTML = '';
            document.getElementById('geocode-progress').textContent = '0';
            document.getElementById('geocode-total').textContent = '0';
            document.getElementById('geocode-progress-bar').style.width = '0%';
            document.getElementById('geocode-progress-bar').textContent = '0%';
            document.getElementById('geocode-status').textContent = '';
            geocodingResults = [];
            
            // Clear map markers
            if (geocodingMap) {
                const markers = document.querySelectorAll('.mapboxgl-marker');
                markers.forEach(m => m.remove());
            }
        }
    </script>
</body>
</html>

